<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>College Attendance App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    input,
    button {
      width: 100%;
      padding: 10px;
      margin: 6px 0 12px 0;
      font-size: 16px;
      box-sizing: border-box;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #studentName {
      font-weight: bold;
      min-height: 1.2em;
      color: #333;
      margin-top: -10px;
      margin-bottom: 10px;
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
      min-height: 1.2em;
    }
  </style>
</head>

<body>
  <h1>College Attendance</h1>

  <form id="attendanceForm" autocomplete="off">
    <label for="registerNumber">Register Number:</label>
    <input type="text" id="registerNumber" name="registerNumber" placeholder="Enter Register Number" required />
    <div id="studentName"></div>
    <button type="submit">Mark Present</button>
  </form>

  <p id="status" aria-live="polite"></p>

  <script>
    const registerMap = new Map([
      ["2303412514822002", "ABINAYA R"],
      ["2303412514822003", "ABIRAMI S"],
      // ... other student mappings ...
      ["2303412514821119", "VIJAYAKUMARAN K"]
    ]);

    const intervals = [
      [9, 0, 9, 50],
      [9, 51, 10, 40],
      [10, 56, 11, 45],
      [11, 46, 12, 35],
      [13, 26, 14, 15],
      [14, 16, 15, 6],
      [15, 6, 16, 0],
    ];

    function timeToMinutes(h, m) {
      return h * 60 + m;
    }

    const registerInput = document.getElementById("registerNumber");
    const studentNameDiv = document.getElementById("studentName");
    const statusEl = document.getElementById("status");

    registerInput.addEventListener("input", () => {
      const val = registerInput.value.trim();
      studentNameDiv.textContent = registerMap.get(val) || "";
    });

    document.getElementById("attendanceForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      statusEl.textContent = "Submitting...";
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;

      const registerVal = registerInput.value.trim();
      if (!registerVal || !registerMap.has(registerVal)) {
        statusEl.textContent = "Invalid Register Number.";
        submitBtn.disabled = false;
        return;
      }

      const studentName = registerMap.get(registerVal);
      const now = new Date();
      const day = now.getDay();
      if (day === 0 || day === 6) {
        statusEl.textContent = "Attendance can be marked Monday to Friday.";
        submitBtn.disabled = false;
        return;
      }

      const nowMinutes = now.getHours() * 60 + now.getMinutes();
      let intervalIndex = -1;
      for (let i = 0; i < intervals.length; i++) {
        const [sh, sm, eh, em] = intervals[i];
        if (nowMinutes >= timeToMinutes(sh, sm) && nowMinutes <= timeToMinutes(eh, em)) {
          intervalIndex = i;
          break;
        }
      }

      if (intervalIndex === -1) {
        statusEl.textContent = "Outside allowed time intervals.";
        submitBtn.disabled = false;
        return;
      }

      const dateKey = now.toISOString().slice(0, 10).replace(/-/g, "");
      const attendanceKey = `attendance_${dateKey}_interval${intervalIndex}_${registerVal}`;
      if (localStorage.getItem(attendanceKey)) {
        statusEl.textContent = "Attendance already marked for this interval.";
        submitBtn.disabled = false;
        return;
      }

      try {
        const resIp = await fetch("https://api.ipify.org?format=json");
        if (!resIp.ok) throw new Error("Failed to retrieve IP.");
        const { ip: clientIp } = await resIp.json();

        if (!clientIp.startsWith("136.232.10.")) {
          statusEl.textContent = "Must be connected to college WiFi.";
          submitBtn.disabled = false;
          return;
        }

        const formData = new URLSearchParams();
        formData.append("registerNumber", registerVal);
        formData.append("studentName", studentName);
        formData.append("clientIp", clientIp);

        const scriptUrl = "https://script.google.com/macros/s/1tADCef_YI9USBSHwaL0ZiI2NtBw2BskJtm9vjlyrSgRpd-egaxQKQCfd/exec";

        const response = await fetch(scriptUrl, { method: "POST", body: formData });
        const json = await response.json();

        if (json.status === "success") {
          localStorage.setItem(attendanceKey, now.getTime().toString());
          statusEl.textContent = json.message;
          e.target.reset();
          studentNameDiv.textContent = "";
        } else {
          statusEl.textContent = `Error: ${json.message}`;
        }
      } catch (err) {
        statusEl.textContent = "Submission failed. Try again.";
      } finally {
        submitBtn.disabled = false;
        setTimeout(() => statusEl.textContent = "", 5000);
      }
    });
  </script>
</body>

</html>
